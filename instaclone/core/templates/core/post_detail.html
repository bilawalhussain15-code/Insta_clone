
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Posts by {{ post.user.username }} - Instaclone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery for AJAX -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-900 text-white">

<!-- Navigation -->
<nav class="bg-gray-800 p-4 flex justify-between items-center sticky top-0 z-10">
    <a href="{% url 'home' %}" class="text-xl font-bold">‚Üê Home</a>
    <div class="text-lg font-semibold">{{ post.user.username }}'s Posts</div>
    <a href="{% url 'user_profile' post.user.username %}" class="bg-blue-600 px-3 py-1 rounded text-sm">View Profile</a>
</nav>

<!-- Main Vertical Feed -->
<div class="max-w-2xl mx-auto pt-4 pb-8" id="posts-container">
    {% for user_post in user_posts %}
    <div id="post-{{ user_post.id }}" class="bg-gray-800 rounded-lg mb-6 {% if user_post.id == post.id %}border-2 border-blue-500{% endif %}">
        <!-- User Header -->
        <div class="flex items-center space-x-4 p-4">
            {% if user_post.user.profile_picture %}
                <img src="{{ user_post.user.profile_picture.url }}" class="w-10 h-10 rounded-full object-cover">
            {% else %}
                <div class="w-10 h-10 rounded-full bg-gray-600"></div>
            {% endif %}
            <div>
                <a href="{% url 'user_profile' user_post.user.username %}" class="font-bold hover:underline">
                    {{ user_post.user.username }}
                </a>
                <p class="text-gray-400 text-xs">{{ user_post.created_at|timesince }} ago</p>
            </div>
        </div>

        <!-- Post Media -->
        <div class="flex justify-center bg-black">
            {% if user_post.is_video %}
                {% if user_post.video %}
                    <video controls class="w-full object-contain max-h-[60vh]" id="video-{{ user_post.id }}">
                        <source src="{{ user_post.video.url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                {% else %}
                    <div class="w-full h-96 bg-gray-700 flex items-center justify-center">
                        <span class="text-gray-400">Video not available</span>
                    </div>
                {% endif %}
            {% else %}
                {% if user_post.image %}
                    <img src="{{ user_post.image.url }}" alt="Post Image" class="w-full object-contain max-h-[60vh]">
                {% else %}
                    <div class="w-full h-96 bg-gray-700 flex items-center justify-center">
                        <span class="text-gray-400">Image not available</span>
                    </div>
                {% endif %}
            {% endif %}
        </div>

        <!-- Engagement Buttons -->
        <div class="p-4">
            <div class="flex items-center space-x-4 mb-2">
                <!-- Like Button -->
                <button onclick="toggleLike({{ user_post.id }})" class="flex items-center space-x-1 hover:text-red-500 like-btn-{{ user_post.id }}">
                    {% if user_post.is_liked %}
                        <span class="text-red-500 text-xl" id="like-icon-{{ user_post.id }}">‚ù§Ô∏è</span>
                    {% else %}
                        <span class="text-xl" id="like-icon-{{ user_post.id }}">ü§ç</span>
                    {% endif %}
                    <span class="text-sm" id="like-count-{{ user_post.id }}">({{ user_post.likes_count }})</span>
                </button>

                <!-- Comment Button -->
                <a href="{% url 'post_detail' user_post.id %}" class="flex items-center space-x-1 hover:text-blue-400">
                    <span class="text-xl">üí¨</span>
                    <span class="text-sm" id="comment-count-{{ user_post.id }}">({{ user_post.comments_count }})</span>
                </a>
            </div>

            <!-- Caption -->
            {% if user_post.caption %}
                <p class="mb-2">
                    <span class="font-bold">{{ user_post.user.username }}</span>: {{ user_post.caption }}
                </p>
            {% endif %}

            <!-- View Comments Link -->
            {% if user_post.comments_count > 3 %}
                <a href="{% url 'post_detail' user_post.id %}" class="text-gray-400 text-sm hover:underline">
                    View all {{ user_post.comments_count }} comments
                </a>
            {% endif %}

            <!-- Add Comment Form -->
            <form onsubmit="addComment(event, {{ user_post.id }})" class="mt-3 flex items-center space-x-2 border-t border-gray-700 pt-3">
                <input type="text" id="comment-text-{{ user_post.id }}" placeholder="Add a comment..." 
                       class="flex-1 bg-gray-700 rounded-full px-3 py-2 text-sm">
                <button type="submit" class="text-blue-400 font-semibold text-sm">Post</button>
            </form>
        </div>

        <!-- Comments Section - ONLY ONE SECTION SHOULD BE HERE -->
        {% if user_post.comment_set.all %}
        <div class="p-4 border-t border-gray-700">
            <h4 class="font-semibold text-sm mb-3">Comments</h4>
            <div class="comments-container-{{ user_post.id }}">
                {% for comment in user_post.comment_set.all %}
                <div class="flex items-start space-x-2 mb-3" id="comment-{{ comment.id }}">
                    {% if comment.user.profile_picture %}
                        <img src="{{ comment.user.profile_picture.url }}" class="w-8 h-8 rounded-full object-cover">
                    {% else %}
                        <div class="w-8 h-8 rounded-full bg-gray-600"></div>
                    {% endif %}
                    <div class="flex-1">
                        <a href="{% url 'user_profile' comment.user.username %}" class="font-bold text-sm hover:underline">
                            {{ comment.user.username }}
                        </a>
                        <p class="text-gray-300 text-sm">{{ comment.text }}</p>
                        <div class="flex items-center space-x-3 mt-1">
                            <span class="text-gray-500 text-xs">{{ comment.created_at|timesince }} ago</span>
                            
                            <!-- Comment Like Button -->
                            <button onclick="toggleCommentLike({{ comment.id }})" class="flex items-center space-x-1 text-gray-500 hover:text-red-400 text-xs comment-like-btn-{{ comment.id }}">
                                {% if comment.is_liked %}
                                    <span class="text-red-400" id="comment-like-icon-{{ comment.id }}">‚ù§Ô∏è</span>
                                {% else %}
                                    <span id="comment-like-icon-{{ comment.id }}">ü§ç</span>
                                {% endif %}
                                <span id="comment-like-count-{{ comment.id }}">({{ comment.likes_count }})</span>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<script>
// CSRF Token for AJAX
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Like/Unlike Post
function toggleLike(postId) {
    $.ajax({
        url: `/post/${postId}/like/`,
        type: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            const likeIcon = $(`#like-icon-${postId}`);
            const likeCount = $(`#like-count-${postId}`);
            
            if (response.liked) {
                likeIcon.html('‚ù§Ô∏è').addClass('text-red-500');
                likeCount.text(`(${response.likes_count})`);
            } else {
                likeIcon.html('ü§ç').removeClass('text-red-500');
                likeCount.text(`(${response.likes_count})`);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
        }
    });
}

// Add Comment
function addComment(event, postId) {
    event.preventDefault();
    const commentText = $(`#comment-text-${postId}`).val().trim();
    
    if (!commentText) return;
    
    $.ajax({
        url: `/post/${postId}/comment/`,
        type: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        data: {
            text: commentText
        },
        success: function(response) {
            if (response.success) {
                // Clear input
                $(`#comment-text-${postId}`).val('');
                
                // Update comment count
                const commentCount = $(`#comment-count-${postId}`);
                commentCount.text(`(${response.comments_count})`);
                
                // Add new comment to the comments section
                const commentsContainer = $(`.comments-container-${postId}`);
                const newCommentHtml = `
                    <div class="flex items-start space-x-2 mb-3" id="comment-${response.comment_id}">
                        <div class="w-8 h-8 rounded-full bg-gray-600"></div>
                        <div class="flex-1">
                            <a href="/profile/${response.username}/" class="font-bold text-sm hover:underline">
                                ${response.username}
                            </a>
                            <p class="text-gray-300 text-sm">${commentText}</p>
                            <div class="flex items-center space-x-3 mt-1">
                                <span class="text-gray-500 text-xs">just now</span>
                                <button onclick="toggleCommentLike(${response.comment_id})" class="flex items-center space-x-1 text-gray-500 hover:text-red-400 text-xs comment-like-btn-${response.comment_id}">
                                    <span id="comment-like-icon-${response.comment_id}">ü§ç</span>
                                    <span id="comment-like-count-${response.comment_id}">(0)</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add new comment at the top
                commentsContainer.prepend(newCommentHtml);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
        }
    });
}

// Like/Unlike Comment
function toggleCommentLike(commentId) {
    $.ajax({
        url: `/comment/${commentId}/like/`,
        type: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            const likeIcon = $(`#comment-like-icon-${commentId}`);
            const likeCount = $(`#comment-like-count-${commentId}`);
            
            if (response.liked) {
                likeIcon.html('‚ù§Ô∏è').addClass('text-red-400');
                likeCount.text(`(${response.likes_count})`);
            } else {
                likeIcon.html('ü§ç').removeClass('text-red-400');
                likeCount.text(`(${response.likes_count})`);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
        }
    });
}
</script>

</body>
</html>